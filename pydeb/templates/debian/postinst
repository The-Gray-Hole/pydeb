#!/bin/bash

set -e

PACKAGE="{{ pydeb['package-name'] }}"
DEPENDENCIES_PATH="/var/$PACKAGE/wheels"
WHEELHOUSE="dependencies-wheels"
VENV_PATH="{{ pydeb['venv-path'] }}"

case "$1" in
    configure)
        mkdir -p "$VENV_PATH"
{% if pydeb['reset-venv-on-updates'] %}
        if [ -d "$VENV_PATH" ]; then
            rm -r "$VENV_PATH"
        fi
{% endif %}
        tar -zxf "$DEPENDENCIES_PATH/$WHEELHOUSE".tar.gz -C "$DEPENDENCIES_PATH"
        rm "$DEPENDENCIES_PATH/$WHEELHOUSE".tar.gz
        {{ pydeb['python-bin'] }} -m venv "$VENV_PATH"
        "$VENV_PATH/bin/python" -m pip install pip --upgrade --no-index --find-links "$DEPENDENCIES_PATH/$WHEELHOUSE"
        "$VENV_PATH/bin/python" -m pip install "$PACKAGE" --no-index --find-links "$DEPENDENCIES_PATH/$WHEELHOUSE"
        rm -r "$DEPENDENCIES_PATH/$WHEELHOUSE"
{% for cs in pydeb['console-scripts'] %}
        ln -s -f "$VENV_PATH/bin/{{cs}}" /usr/local/bin/{{cs}}{% endfor %}
    ;;

    abort-upgrade|abort-remove|abort-deconfigure)
    ;;

    *)
        echo "postinst called with unknown argument \`$1'" >&2
        exit 1
    ;;
esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#

exit 0
